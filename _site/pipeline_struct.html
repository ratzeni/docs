<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="pipeline_handbook,  solida, solida-core, bioinformatics pipelines,">
<title>Pipeline Handbook | solida-docs</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> SOLIDA-CORE</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-left">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->
            </ul>
            
            <ul class="nav navbar-nav navbar-right">




                
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Pipelines<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://github.com/solida-core/diva" target="_blank" rel="noopener">diva</a></li>
                        
                        
                        
                        <li><a href="https://github.com/solida-core/dima" target="_blank" rel="noopener">dima</a></li>
                        
                        
                    </ul>
                </li>
                
                

                
                
                
                <li><a href="https://snakemake.readthedocs.io/en/stable/" target="_blank" rel="noopener">Snakemake</a></li>
                
                
                
                <li><a href="https://github.com/solida-core" target="_blank" rel="noopener">GitHub</a></li>
                
                
                
                <li><a href="https://next.crs4.it" target="_blank" rel="noopener">next@crs4</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Pipeline Handbook">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">solida-docs 1.0</li>
  
  
  
      
  
  <li>
      <a title="solida-core" href="#">solida-core</a>
      <ul>
          
          
          
          <li><a title="Overview" href="index.html">Overview</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Pipeline Handbook" href="#">Pipeline Handbook</a>
      <ul>
          
          
          
          <li class="active"><a title="Structure" href="pipeline_struct.html">Structure</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Available Pipelines" href="#">Available Pipelines</a>
      <ul>
          
          
          
          <li><a title="DiVA (DNA Variant Analysis)" href="diva.html">DiVA (DNA Variant Analysis)</a></li>
          
          
          
          
          
          
          <li><a title="DiMA (DNA Mapping)" href="dima.html">DiMA (DNA Mapping)</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="solida" href="#">solida</a>
      <ul>
          
          
          
          <li><a title="command-line tool" href="solida_cli.html">command-line tool</a></li>
          
          
          
          
          
          
          <li><a title="GUI" href="solida_gui.html">GUI</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Pipeline Handbook</h1>
</div>



<div class="post-content">

   
    <div class="summary"></div>
   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

   <h2 id="pipeline-structure">PIPELINE STRUCTURE</h2>

<p><a href="https://github.com/solida-core">solida-core</a> pipelines are based on Snakemake and for this reason are organized in a defined structure of files and directories.</p>

<p>The content of a general pipeline directory an be summarized as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PIPELINE FOLDER
    │
    ├── Snakefile
    |
    ├── config.yaml
    |
    ├── envs
    │   ├── rule_a_env.yaml
    │   └── rule_b_env.yaml
    |
    ├── rules
    │   ├── rules_file_1.smk
    │   ├── rules_file_2.smk
    │   └── scripts
    │       └── personal_script_a
    |
    ├── environment.yaml
    |
    └── user_data_file_1.tsv
</code></pre></div></div>
<h3 id="configfile">Configfile</h3>
<p>The configfile, generally present in out pipelines as <code class="highlighter-rouge">config.yaml</code>, is a file containing multiple dictionaries which is queried by Snakemake during each step execution.</p>

<p>In fact, in each process of the pipeline, called <a href="#rules">rule</a>, a section of the configfile can be imported for passing parameters to a function or the path of a given file or whatever the user want to import.</p>

<p>In example, the following configfile section:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>genome_fasta: "reference_files_path/my_genome.fasta"
mapping_parameters: "-A 20 -C 40"
</code></pre></div></div>
<p>shows the specification of a fasta file with its path and a couple of parameters for an hypotetical mapping step.</p>

<p>Snakemake allows accessing information contained in the configfile via the global variable <code class="highlighter-rouge">config</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config.get("genome_fasta")
config.get("mapping_parameters")
</code></pre></div></div>
<p>In this way it is possible the separation between general structure of an analysis workflow and the related parameters that can be edited in a specific configuration file.</p>

<h3 id="rules">Rules</h3>
<p>Snakemake workflows are essentially Python scripts extended by declarative code to define rules, which describe how to create output files from input files.</p>

<p>Generally a rule is composed by the rule name, input and output and the command which generates the output.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule my_rule_name:
    input:
        "raw/my_first_input"
    output:
        "plots/my_first_output"
    shell:
        "somecommand {input} {output}"
</code></pre></div></div>
<p>The output of a given rule can be either the input of a successive rule. In this way it is possible build a workflow comprising multiple steps. Snakemake determines the rule dependencies by matching file names.</p>

<p>Further <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/writing_snakefiles.html#grammar">arguments</a> of a rule that can be included are <code class="highlighter-rouge">log</code>,<code class="highlighter-rouge">params</code>,<code class="highlighter-rouge">benchmark</code>,<code class="highlighter-rouge">threads</code>,<code class="highlighter-rouge">conda</code>,<code class="highlighter-rouge">run</code> and so on. For complete manual directly refer to <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#rules">Snakemake</a>.</p>

<h5 id="scripts">Scripts</h5>
<p>A rule can also point to an external script instead of a shell command or inline Python code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule NAME:
    input:
        "path/to/inputfile",
        "path/to/other/inputfile"
    output:
        "path/to/outputfile",
        "path/to/another/outputfile"
    script:
        "path/to/script.py"
</code></pre></div></div>
<p>The script path is always relative to the Snakefile (in contrast to the input and output file paths, which are relative to the working directory).
Inside the script, you have access to an object <code class="highlighter-rouge">snakemake</code> that provides access to the same objects that are available in the <code class="highlighter-rouge">run</code> and <code class="highlighter-rouge">shell</code> directives (input, output, params, wildcards, log, threads, resources, config), e.g. you can use <code class="highlighter-rouge">snakemake.input[0]</code> to access the first input file of above rule.</p>

<p>Apart from Python scripts, this mechanism also allows you to integrate R and R Markdown scripts with Snakemake:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule NAME:
    input:
        "path/to/inputfile",
        "path/to/other/inputfile"
    output:
        "path/to/outputfile",
        "path/to/another/outputfile"
    script:
        "path/to/script.R"
</code></pre></div></div>
<p>In the R script, an S4 object named <code class="highlighter-rouge">snakemake</code> analog to the Python case above is available and allows access to input and output files and other parameters.
Here the syntax follows that of S4 classes with attributes that are R lists: we can access the first input file with <code class="highlighter-rouge">snakemake@input[[1]]</code> (note that the first file does not have index 0 here, because R starts counting from 1).</p>

<h3 id="envs">Envs</h3>
<p>With Snakemake it is possible to define isolated software environments per rule.
Upon execution of a workflow, the <a href="https://conda.io/en/latest/">Conda package manager</a> is used to obtain and deploy the defined software packages in the specified versions.</p>

<p>Packages will be installed into your working directory, without requiring any admin/root priviledges.</p>

<p>Given that conda is available on your system (see <a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>), to use the Conda integration, add the <code class="highlighter-rouge">--use-conda</code> flag to your workflow execution command, e.g. <code class="highlighter-rouge">snakemake --cores 8 --use-conda</code>.</p>

<p>When <code class="highlighter-rouge">--use-conda</code> is activated, Snakemake will automatically create software environments for any used wrapper (see <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/modularization.html#wrappers">Wrappers</a>).</p>

<p>Further, you can manually define environments via the <code class="highlighter-rouge">conda</code> directive:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule NAME:
    input:
        "table.txt"
    output:
        "plots/myplot.pdf"
    conda:
        "envs/ggplot.yaml"
    script:
        "scripts/plot-stuff.R"
</code></pre></div></div>
<p>where the <code class="highlighter-rouge">ggplot.yaml</code> file contains the following environment definition:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>channels:
 - r
dependencies:
 - r=3.3.1
 - r-ggplot2=2.1.0
</code></pre></div></div>
<p><a href="">solida-core</a> pipelines include all environment definition files inside the <code class="highlighter-rouge">envs/</code> folder.</p>

<h3 id="snakefile">Snakefile</h3>
<p>The <strong>Snakefile</strong> of a Snakemake-based pipeline is mostly the “head” of the workflow.
In fact in this file there is a “target” rule named <code class="highlighter-rouge">rule all</code> which inputs are the desired output files that the workflow should produce.</p>

<p>Given that Snakemake automatically checks rule dependencies by matching input/output filenames, it is not necessary to inlcude in the rule all every generated output file. The required ones are those produced in the last step of a workflow ramo (CLADE?).</p>

<p>This section looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule all:
    input:
        "reads/my_sample.bam",
        "qc/multiqc.html",
        "variant_calling/my_sample.vcf"

</code></pre></div></div>
<p>In this case we have 3 desired outputs:</p>
<ul>
  <li>a BAM file</li>
  <li>a MULTIQC report</li>
  <li>a VCF file</li>
</ul>

<p>From these files, Snakemake performs a back-check for input/output matches. If the BAM file is inlcuded in VCF file generation steps, is not required to be indicated in the rule all, because that clade of the workflow is aimed at producing the VCF.</p>

<p>On the other hand, because the MULTIQC report is not input of any dependency for generating the VCF file, it needs to be indicated. Is like a collateral part of the main workflow.</p>

<p>Other two sections of Snakefile need to be mentioned.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### LOAD LIBRARIES
import pandas as pd


## USER FILES ##
samples = pd.read_csv(config["samples"], index_col="sample", sep="\t")
</code></pre></div></div>
<p>The above section represent an example of library loading and its usage in creating variables.
In this case we used pandas to read a table in which we stored sample names.
Notice that the complete path and the filename are declared in the configfile under the <code class="highlighter-rouge">samples</code> entry.</p>

<p>Finally,files including rules to be executed by a Snakefile need to be “included” with the <code class="highlighter-rouge">include</code> statement as follows:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include: "rules/my_first_set_of_rules.smk"
include: "rules/another_set_of_rules.smk"
include: "otherfolder/set_of_rules_in_a_different_folder.smk"
</code></pre></div></div>

<p>Further information and tutorials can be found in the <a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a> official page.
<strong>__</strong><strong>__</strong><strong>__</strong>_
Part of the documentation reported in this file comes from <a href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a> official guide.</p>


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        
        
    </div>




</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                    <p><a href="http://next.crs4.it" target="_blank">
                        <img src="images/company_logo.png" alt="Company logo" style="width:50%;"/></a></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
